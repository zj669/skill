# Phase 2: æ­£æ–‡å†™ä½œåè®® (Scene Writer Protocol)

## ğŸ“Œ ç›®æ ‡
åŸºäºç»†çº²ï¼Œç”Ÿæˆé«˜è´¨é‡çš„ç« èŠ‚æ­£æ–‡ã€‚é€šè¿‡ RAG æ£€ç´¢å’ŒçŠ¶æ€æ ¡éªŒï¼Œç¡®ä¿å‰§æƒ…é€»è¾‘è‡ªæ´½ã€‚

---

## ğŸ­ Sub-Skill: Scene_Writer

**è§’è‰²å®šä½**: ä½ æ˜¯æ‰§è¡Œå†™æ‰‹ï¼Œè´Ÿè´£å°†ç»†çº²è½¬åŒ–ä¸ºç”ŸåŠ¨çš„æ­£æ–‡ã€‚

**æ ¸å¿ƒçº¦æŸ**:
- ä¸¥ç¦å‡­ç©ºåˆ›é€ ç‰©å“/æŠ€èƒ½ï¼ˆå¿…é¡»æŸ¥åº“ï¼‰
- ä¸¥ç¦å¤æ´»å·²æ­»äº¡è§’è‰²ï¼ˆå¿…é¡»æŸ¥å›¾è°±ï¼‰
- ä¸¥ç¦è¿åæˆ˜åŠ›é”šç‚¹ï¼ˆå¿…é¡»æŸ¥é…ç½®ï¼‰

---

## ğŸ›  æ‰§è¡Œæ­¥éª¤

### Step 0: ä¸Šä¸‹æ–‡ä¸€æ¬¡æ€§åŠ è½½ (Context Loading) ğŸ¯ CRITICAL

> [!CAUTION]
> ğŸ”§ **MUST_EXECUTE** - ä½ å¿…é¡»å®é™…æ‰§è¡Œæ­¤è„šæœ¬ï¼Œä¸å¾—è·³è¿‡ï¼

**é¦–å…ˆç¡®ä¿ç›®å½•å­˜åœ¨**:
```bash
mkdir -p volumes/volume_{v}/chapters/chapter_{n}/execute_logs
```

**æ‰§è¡Œå‘½ä»¤** (ç»“æœä¿å­˜åˆ°execute_logs):
```bash
python scripts/context_loader.py --mode writing --chapter {n} \
  --characters '["å¶å‡¡", "è€çˆ·çˆ·"]' \
  --rag-queries '["æˆ˜æ–—åœºæ™¯æå†™", "åŠŸæ³•ç‰¹æ•ˆ"]' \
  --output-dir "volumes/volume_{v}/chapters/chapter_{n}/execute_logs"
```

**âœ… æ‰§è¡Œæ£€æŸ¥ç‚¹** - ä½ å¿…é¡»æŠ¥å‘Š:
```
ğŸ”§ æ‰§è¡Œå‘½ä»¤: python scripts/context_loader.py --mode writing ...
ğŸ“Š è¿”å›çŠ¶æ€: SUCCESS / ERROR
ğŸ“‹ å…³é”®æ•°æ®: 
   - ä¸Šç« å°¾å£°: "...å‰50å­—..."
   - æ´»è·ƒé’©å­: [...]
   - ä¸»è§’ç­‰çº§: xxx
```

**è¿”å›å†…å®¹ (ä¸€æ¬¡æ€§è·å–)**:
```json
{
  "chapter": 16,
  "status": "SUCCESS",
  "data": {
    "progress": {"current_volume": 1, "current_chapter": 16, "process_step": "NEED_DRAFT"},
    "previous_chapter_tail": "...ä¸Šç« æœ€å500å­—...",
    "active_hooks": ["æˆ’æŒ‡è€çˆ·çˆ·èº«ä»½", "ç‹å®¶è¿½æ€ä»¤"],
    "emo_curve": [10, -5, -20, 15, -10],
    "protagonist": {"name": "å¶å‡¡", "level": "ç»ƒæ°”ä¸‰å±‚", "inventory": [...]},
    "character_voices": {
      "å¶å‡¡": {"tone": "æ²‰ç¨³å†…æ•›", "samples": ["ä½ è§‰å¾—æˆ‘ä¼šä¿¡ï¼Ÿ"]},
      "è€çˆ·çˆ·": {"tone": "é«˜æ·±è«æµ‹", "samples": ["å°å­ï¼Œä½ çš„é€ åŒ–æ¥äº†ã€‚"]}
    },
    "rag_references": {
      "æˆ˜æ–—åœºæ™¯æå†™": [...ç›¸å…³ç´ æ...],
      "åŠŸæ³•ç‰¹æ•ˆ": [...ç›¸å…³ç´ æ...]
    }
  }
}
```

**é”šå®šä¸‰è¦ç´ ** (ä»ä¸Šä¸‹æ–‡ä¸­æå–):
| è¦ç´  | æ•°æ®æ¥æº | çº¦æŸ |
|------|----------|------|
| æ—¶é—´é”šç‚¹ | `previous_chapter_tail` | ä¸å¯è·³è·ƒè¶…è¿‡24å°æ—¶ |
| ç©ºé—´é”šç‚¹ | `previous_chapter_tail` | å¼€ç¯‡100å­—å†…å¿…é¡»äº¤ä»£ |
| æƒ…ç»ªé”šç‚¹ | `emo_curve[-1]` | å¿…é¡»å¹³æ»‘è¿‡æ¸¡ |

**å¼€ç¯‡çº¦æŸ** (å‰100å­—):
- âœ… å¿…é¡»æ‰¿æ¥ `previous_chapter_tail` çš„æœ€åä¸€ä¸ªåŠ¨ä½œ/å¯¹è¯
- âŒ ç¦æ­¢ä½¿ç”¨ã€Œç¿Œæ—¥æ¸…æ™¨ã€ã€Œæ•°æ—¥åã€ç­‰è·³è·ƒå¼€å¤´

**å°¾é’©çº¦æŸ** (æœ€å100å­—):
- âœ… å¿…é¡»åŒ…å«ä¸€ä¸ªã€Œæœªè§£å†³é—®é¢˜ã€
- ğŸ”§ **MUST_EXECUTE** å®Œæˆåè°ƒç”¨:
  ```bash
  python scripts/state_manager.py --action add_hook --text "{hook}"
  ```

---

### Step 1: Pre-Flight Check (çº¢ç¯æ ¡éªŒ) ğŸš¨

**å¿…é¡»åœ¨å†™ä½œå‰æ‰§è¡Œ** (ä½¿ç”¨ä¸Šä¸‹æ–‡ä¸­çš„protagonistæ•°æ®æ ¡éªŒ):
```bash
python scripts/state_manager.py --action preflight --scene_plan "{scene_json}"
```

**æ ¡éªŒé¡¹ç›®** (æ•°æ®å·²åœ¨ä¸Šä¸‹æ–‡ä¸­):
| æ£€æŸ¥é¡¹ | æ•°æ®æº | å¤±è´¥å¤„ç† |
|--------|--------|----------|
| ç‰©å“å¯ç”¨æ€§ | `context.protagonist.inventory` | è·³è½¬ Phase X |
| è§’è‰²å­˜æ´»çŠ¶æ€ | `context.character_relations` | è·³è½¬ Phase X |
| æŠ€èƒ½å·²å­¦ä¹  | `context.protagonist.skills` | è·³è½¬ Phase X |

---

### Step 2: æ­£æ–‡ç”Ÿæˆ (Beat-by-Beat Writing)

**å†™ä½œè§„èŒƒ**:

1. **æŒ‰èŠ‚æ‹è¡¨é€æ®µå†™ä½œ**: ä¸¥æ ¼æŒ‰ç…§ `02_plot_architect` ç”Ÿæˆçš„èŠ‚æ‹è¡¨æ‰§è¡Œ
2. **åœºæ™¯åˆ‡æ¢**: ä½¿ç”¨ `---` åˆ†éš”ä¸åŒåœºæ™¯ï¼ˆéœ€ä¸èŠ‚æ‹è¾¹ç•Œå¯¹é½ï¼‰
3. **å¯¹è¯æ ¼å¼**: 
   ```
   "å°è¯å†…å®¹ã€‚"è§’è‰²åè¯´é“/é“/å†·ç¬‘é“ã€‚
   ```
4. **æˆ˜æ–—æå†™**: å¿…é¡»å¼•ç”¨ RAG æ£€ç´¢åˆ°çš„åŠŸæ³•ç‰¹æ•ˆ
5. **å­—æ•°æ§åˆ¶**: 
   - å…¨ç« å›ºå®š **3500å­— Â±300**
   - æ¯ä¸ªèŠ‚æ‹å­—æ•°å‚è€ƒèŠ‚æ‹è¡¨é¢„ç®—
   - å®Œæˆæ¯ä¸ªèŠ‚æ‹åç»Ÿè®¡å½“å‰å­—æ•°

**èŠ‚æ‹å†™ä½œæ£€æŸ¥ç‚¹**:
```
[èŠ‚æ‹1å®Œæˆ] å½“å‰å­—æ•°: ~300å­— âœ“
[èŠ‚æ‹2å®Œæˆ] å½“å‰å­—æ•°: ~700å­— âœ“
[èŠ‚æ‹3å®Œæˆ] å½“å‰å­—æ•°: ~1200å­— âœ“
[èŠ‚æ‹4å®Œæˆ] å½“å‰å­—æ•°: ~2000å­— âœ“
[èŠ‚æ‹5å®Œæˆ] å½“å‰å­—æ•°: ~3000å­— âœ“
[èŠ‚æ‹6å®Œæˆ] å½“å‰å­—æ•°: ~3500å­— âœ“
```

**ç¦æ­¢äº‹é¡¹**:
- âŒ ä½¿ç”¨æœªæ£€ç´¢åˆ°çš„åŠŸæ³•åç§°
- âŒ è®©è§’è‰²ä½¿ç”¨èƒŒåŒ…é‡Œæ²¡æœ‰çš„ç‰©å“
- âŒ å‡ºç°"ç¬¬äºŒå¤©"ç­‰æ—¶é—´è·³è·ƒï¼ˆé™¤éèŠ‚æ‹è¡¨æ˜ç¡®ï¼‰
- âŒ å•ç« å­—æ•°ä½äº3200æˆ–è¶…è¿‡3800

---

### Step 4: è‰ç¨¿è¾“å‡º

**æ ¼å¼**:
```markdown
# ç¬¬ {chapter_num} ç« ï¼š{chapter_title}

{æ­£æ–‡å†…å®¹}

---
<!-- å…ƒæ•°æ® (ä»…ä¾› Data_Manager ä½¿ç”¨) -->
[ITEMS_USED]: ["é’é”‹å‰‘", "çµåŠ›æ¢å¤ä¸¹"]
[ITEMS_GAINED]: ["ç‹å®¶ä»¤ç‰Œ"]
[RELATIONS_CHANGED]: [{"target": "ç‹è™", "change": "DEAD"}]
[EMO_SCORE]: 45
```

---

## ğŸ“„ äº¤ä»˜ç‰©

| è¾“å‡º | ç±»å‹ | ç”¨é€” |
|------|------|------|
| `drafts/chapter_{n}.md` | Markdown | ç« èŠ‚è‰ç¨¿ |
| æ­£æ–‡æœ«å°¾å…ƒæ•°æ® | Comment | ä¾› Data_Manager è§£æ |

## ğŸ›‘ Stop Point / ğŸ”„ Auto-Pilot

**Logic**:
1. **Check Auto-Mode**:
   - If `context.auto_mode` is **True**:
     > ğŸ”§ **MUST_EXECUTE**
     > ```bash
     > python scripts/state_manager.py --action update_step --status NEED_CONTINUITY_CHECK
     > ```
     > "ğŸ”„ Auto-mode: Draft complete. Proceeding to CONTINUITY CHECK..."
   - Else:
     > "Draft complete.
     > Input 'Approve' to proceed to continuity check."
